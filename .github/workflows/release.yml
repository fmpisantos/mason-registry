name: Create Release

on:
  push:
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for release'
        required: true
        type: string

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install yq
        run: |
          wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: Lint packages
        uses: mason-org/actions/registry-lint@v1

      - name: Compile registry
        run: |
          # Create registry.json from all package.yaml files
          echo '{"packages":{}}' > registry.json

          for package_dir in packages/*/; do
            if [ -d "$package_dir" ]; then
              package_name=$(basename "$package_dir")
              package_yaml="${package_dir}package.yaml"

              if [ -f "$package_yaml" ]; then
                echo "Processing $package_name..."

                # Extract package data using yq and add to registry
                package_data=$(yq -o=json '.' "$package_yaml")

                # Add to registry.json
                jq --arg name "$package_name" --argjson data "$package_data" \
                  '.packages[$name] = $data' registry.json > registry_temp.json && \
                mv registry_temp.json registry.json
              fi
            fi
          done

          # Validate the registry.json
          jq '.' registry.json > /dev/null
          echo "Registry compiled successfully"

      - name: Create registry archive
        run: |
          zip registry.json.zip registry.json
          echo "Registry archive created"

      - name: Generate checksums
        run: |
          sha256sum registry.json.zip > checksums.txt
          echo "Checksums generated"

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag_name || github.ref_name }}
          name: ${{ github.event.inputs.tag_name || github.ref_name }}
          draft: false
          prerelease: false
          files: |
            registry.json.zip
            checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}